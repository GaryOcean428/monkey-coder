{
  "$schema": "https://schema.railpack.com",
  "provider": "python",
  "packages": {
    "python": "3.12",
    "node": "20"
  },
  "build": {
    "commands": [
      "echo 'ğŸ’ Starting Monkey Coder build process...'",
      "pip install --no-cache-dir --upgrade pip setuptools wheel",
      "pip install --no-cache-dir -r requirements-deploy.txt",
      "cd packages/core && pip install --no-cache-dir -e .",
      "echo 'ğŸ“¦ Python dependencies installed successfully'",
      "corepack enable",
      "corepack prepare yarn@4.9.2 --activate",
      "echo 'ğŸ”§ Yarn 4.9.2 configured'",
      "yarn install --immutable || yarn install",
      "echo 'ğŸ“¦ Node dependencies installed'",
      "echo 'ğŸ—ï¸ Building frontend with comprehensive environment setup...'",
      "export NEXT_OUTPUT_EXPORT=true",
      "export NODE_ENV=production",
      "export NEXT_TELEMETRY_DISABLED=1",
      "export NEXTAUTH_URL=${NEXTAUTH_URL:-https://coder.fastmonkey.au}",
      "export NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-railway-build-secret-$(date +%s)}",
      "export NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://coder.fastmonkey.au}",
      "export NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://coder.fastmonkey.au}",
      "export DATABASE_URL=${DATABASE_URL:-postgresql://railway.internal:5432/railway}",
      "export STRIPE_PUBLIC_KEY=${STRIPE_PUBLIC_KEY:-pk_test_placeholder}",
      "export STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-sk_test_placeholder}",
      "export STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-whsec_placeholder}",
      "echo 'Environment variables configured for build'",
      "echo 'Attempting frontend build...'",
      "yarn workspace @monkey-coder/web run export || {",
      "  echo 'âš ï¸ Workspace export failed, trying alternative method...'",
      "  cd packages/web && yarn run export || {",
      "    echo 'âš ï¸ Alternative export failed, trying simple build...'",
      "    cd packages/web && yarn run build && {",
      "      echo 'Build completed, checking output...'",
      "      if [ -d .next ]; then",
      "        echo 'Copying .next to out directory...'",
      "        cp -r .next out 2>/dev/null || echo 'Copy failed, continuing...'",
      "      fi",
      "    } || echo 'âŒ All build methods failed'",
      "  }",
      "}",
      "if [ -d packages/web/out ] && [ \"$(ls -A packages/web/out 2>/dev/null)\" ]; then",
      "  echo 'âœ… Frontend build completed successfully'",
      "  ls -la packages/web/out/ | head -10",
      "  echo \"Frontend assets count: $(find packages/web/out -type f | wc -l) files\"",
      "else",
      "  echo 'âŒ Frontend build failed during deployment - will attempt runtime build'",
      "  echo 'This is not fatal, the server will try to build at startup'",
      "fi",
      "echo 'ğŸš€ Build process completed'"
    ]
  },
  "deploy": {
    "startCommand": "python run_server.py",
    "healthCheckPath": "/health",
    "healthCheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  }
}
