{
  "version": "1",
  "metadata": {
    "name": "monkey-coder"
  },
  "build": {
    "provider": "python",
    "packages": {
      "python": "3.12",
      "node": "20"
    },
    "cache": {
      "paths": [
        "/app/.venv/lib/python3.12/site-packages",
        "/root/.cache/yarn",
        "node_modules",
        "packages/web/.next",
        "packages/web/out"
      ]
    },
    "steps": {
      "install": {
        "commands": [
          "echo '🐒 Installing Python dependencies with correct venv path...'",
          "/app/.venv/bin/pip install --no-cache-dir --upgrade pip setuptools wheel",
          "/app/.venv/bin/pip install --no-cache-dir -r requirements-deploy.txt",
          "cd packages/core && /app/.venv/bin/pip install --no-cache-dir -e .",
          "echo '📦 Python dependencies installed successfully'",
          "echo 'Verifying Python installation:'",
          "/app/.venv/bin/python --version",
          "echo 'Verifying pip packages:'",
          "/app/.venv/bin/pip list | head -10"
        ]
      },
      "build": {
        "commands": [
          "echo '🔧 Setting up Node.js and Yarn...'",
          "corepack enable && corepack prepare yarn@4.9.2 --activate",
          "echo '📦 Installing all workspace dependencies...'",
          "yarn install --immutable",
          "echo '✅ Workspace dependencies installed'",
          "echo '🏗️ Building frontend with static export...'",
          "export NODE_ENV=production",
          "export NEXT_TELEMETRY_DISABLED=1",
          "export NEXTAUTH_URL=https://coder.fastmonkey.au",
          "export NEXT_PUBLIC_API_URL=https://coder.fastmonkey.au",
          "export NEXT_PUBLIC_APP_URL=https://coder.fastmonkey.au",
          "cd packages/web && yarn run export",
          "echo '🔍 Verifying frontend build...'",
          "[ -f packages/web/out/index.html ] && echo '✅ Frontend build verified' || (echo '❌ Frontend build failed' && exit 1)",
          "mkdir -p /app/packages/web && cp -r packages/web/out /app/packages/web/",
          "echo '📁 Frontend assets copied to runtime location'",
          "echo '🔍 Final verification of build artifacts:'",
          "echo 'Python executable:' $(ls -la /app/.venv/bin/python)",
          "echo 'Frontend index.html:' $(ls -la /app/packages/web/out/index.html 2>/dev/null || echo 'Missing')",
          "echo '🚀 Build completed successfully'"
        ]
      }
    }
  },
  "deploy": {
    "startCommand": "/app/.venv/bin/python /app/run_server.py",
    "healthCheckPath": "/health",
    "healthCheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3,
    "environment": {
      "VIRTUAL_ENV": "/app/.venv",
      "PATH": "/app/.venv/bin:$PATH",
      "PYTHONPATH": "/app:/app/packages/core"
    }
  }
}