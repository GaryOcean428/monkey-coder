{
  "version": "1",
  "packages": {
    "python": "3.12.11",
    "node": "22.11.0",
    "yarn": "4.9.2"
  },
  "install": [
    { 
      "command": "python -m venv /app/.venv",
      "cache": "/app/.venv"
    },
    { 
      "command": "/app/.venv/bin/pip install --upgrade pip setuptools wheel",
      "description": "Upgrade pip in virtual environment"
    },
    { 
      "command": "/app/.venv/bin/pip install -r requirements.txt",
      "dependsOn": ["requirements.txt", "pyproject.toml"],
      "description": "Install Python dependencies"
    },
    { 
      "command": "corepack enable && corepack prepare yarn@4.9.2 --activate",
      "description": "Enable Yarn 4"
    },
    { 
      "command": "yarn install --immutable",
      "dependsOn": ["package.json", "yarn.lock"],
      "cache": "node_modules",
      "description": "Install Node.js dependencies"
    },
    { 
      "command": "timeout 600 yarn workspace @monkey-coder/web build || echo 'Frontend build failed, using fallback'",
      "dependsOn": ["packages/web/"],
      "output": "packages/web/out",
      "description": "Build frontend with timeout"
    }
  ],
  "deploy": {
    "command": "/app/.venv/bin/python /app/run_server.py",
    "healthCheckPath": "/health",
    "healthCheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  },
  "environment": {
    "NODE_ENV": "production",
    "PYTHON_ENV": "production",
    "PYTHONUNBUFFERED": "1",
    "NEXT_TELEMETRY_DISABLED": "1"
  }
}