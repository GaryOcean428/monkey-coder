{
  "$schema": "https://schema.railpack.com",
  "provider": "python",
  "packages": {
    "python": "3.12",
    "node": "20"
  },
  "build": {
    "cache": {
      "paths": [
        "/app/venv/lib/python3.12/site-packages",
        "/root/.cache/yarn",
        "node_modules",
        "packages/web/.next"
      ]
    },
    "commands": [
      "echo 'ðŸ’ Starting Monkey Coder build process with Railway railpack optimization...'",
      "echo 'Python executable location:' $(which python)",
      "echo 'Virtual environment location:' ${VIRTUAL_ENV:-'Not detected'}",
      "echo 'Installing Python dependencies in virtual environment...'",
      "/app/venv/bin/pip install --no-cache-dir --upgrade pip setuptools wheel",
      "/app/venv/bin/pip install --no-cache-dir -r requirements-deploy.txt",
      "cd packages/core && /app/venv/bin/pip install --no-cache-dir -e .",
      "echo 'ðŸ“¦ Python dependencies installed successfully in /app/venv'",
      "echo 'Setting up Node.js package manager...'",
      "corepack enable",
      "corepack prepare yarn@4.9.2 --activate",
      "echo 'ðŸ”§ Yarn 4.9.2 configured'",
      "yarn install --immutable || yarn install",
      "echo 'ðŸ“¦ Node dependencies installed'",
      "echo 'Building frontend with comprehensive environment setup...'",
  "echo 'DEBUG: Current working directory:' $(pwd)",
  "echo 'DEBUG: Contents of current directory:' $(ls -la)",
  "echo 'DEBUG: Does packages/web exist?' $(ls -la packages/web 2>/dev/null || echo 'No')",
      "export NEXT_OUTPUT_EXPORT=true",
      "export NODE_ENV=production",
      "export NEXT_TELEMETRY_DISABLED=1",
      "export NEXTAUTH_URL=${NEXTAUTH_URL:-https://coder.fastmonkey.au}",
      "export NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-}",
      "export NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://coder.fastmonkey.au}",
      "export NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://coder.fastmonkey.au}",
      "export DATABASE_URL=${DATABASE_URL:-postgresql://railway.internal:5432/railway}",
      "export STRIPE_PUBLIC_KEY=${STRIPE_PUBLIC_KEY:-}",
      "export STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}",
      "export STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}",
      "echo 'Environment variables configured for build'",
      "echo 'Attempting frontend build...'",
      "BUILD_SUCCESS=false",
      "yarn workspace @monkey-coder/web run export && BUILD_SUCCESS=true || {",
      "  echo 'âš ï¸ Workspace export failed, trying alternative method...'",
      "  cd packages/web && yarn install --frozen-lockfile && yarn run export && BUILD_SUCCESS=true || {",
      "    echo 'âš ï¸ Alternative export failed, trying simple build...'",
      "    yarn run build && {",
      "      echo 'Build completed, checking for .next directory...'",
      "      if [ -d .next ]; then",
      "        echo 'Copying .next to out directory...'",
      "        mkdir -p out && cp -r .next/* out/ 2>/dev/null || true",
      "        BUILD_SUCCESS=true",
      "      fi",
      "    } || echo 'âŒ All build methods failed'",
      "  }",
      "}",
      "echo \"Build success status: $BUILD_SUCCESS\"",
      "if [ \"$BUILD_SUCCESS\" = \"true\" ] && [ -d packages/web/out ] && [ \"$(ls -A packages/web/out 2>/dev/null)\" ]; then",
      "  echo 'âœ… Frontend build completed successfully'",
      "  ls -la packages/web/out/ | head -10",
      "  echo \"Frontend assets count: $(find packages/web/out -type f | wc -l) files\"",
      "  echo 'DEBUG: Verifying specific files exist:'",
      "  echo \"  index.html: $(ls -la packages/web/out/index.html 2>/dev/null || echo 'Missing')\"",
      "  echo \"  _next dir: $(ls -d packages/web/out/_next 2>/dev/null || echo 'Missing')\"",
      "else",
      "  echo 'âŒ Frontend build failed during deployment - will attempt runtime build'",
      "  echo 'This is not fatal, the server will try to build at startup'",
      "fi",
  "echo 'ðŸ” Verifying frontend build integrity (relaxed mode)...'",
  "FRONTEND_VALID=false",
  "if [ -f packages/web/out/index.html ]; then",
  "  FRONTEND_HASH=$(sha256sum packages/web/out/index.html | awk '{print $1}')",
  "  echo 'âœ… Frontend verification passed: index.html present'",
  "  echo \"ðŸ” index.html sha256: ${FRONTEND_HASH}\"",
  "  FRONTEND_VALID=true",
  "  # Check for assets directory (either _next or static)",
  "  if [ -d packages/web/out/_next ]; then",
  "    echo 'âœ… Next.js _next directory found'",
  "  elif [ -d packages/web/out/static ]; then",
  "    echo 'âœ… Static assets directory found'",
  "  else",
  "    echo 'âš ï¸ No asset directory found, but continuing (may be a simple static site)'",
  "  fi",
  "  # Copy to both primary and fallback paths for Railway deployment",
  "  mkdir -p /app/packages/web",
  "  cp -r packages/web/out /app/packages/web/out 2>/dev/null || true",
  "  cp -r packages/web/out /app/out 2>/dev/null || true",
  "  echo 'ðŸ“ Copied build to /app/packages/web/out (primary path)'",
  "  echo 'ðŸ“ Copied build to /app/out (fallback path)'",
  "  echo 'DEBUG: Verifying copy operations:'",
  "  echo \"  /app/packages/web/out exists: $(ls -d /app/packages/web/out 2>/dev/null && echo 'Yes' || echo 'No')\"",
  "  echo \"  /app/out exists: $(ls -d /app/out 2>/dev/null && echo 'Yes' || echo 'No')\"",
  "  echo \"  /app/packages/web/out/index.html: $(ls -la /app/packages/web/out/index.html 2>/dev/null || echo 'Missing')\"",
  "else",
  "  echo 'âš ï¸ Frontend verification found no index.html'",
  "  echo '    Expected: packages/web/out/index.html'",
  "  echo '    Continuing with API-only deployment (server will create fallback)'",
  "fi",
      "echo 'Creating virtual environment activation script...'",
      "cat > /app/start_server.sh << 'EOF'",
      "#!/bin/bash",
      "set -e",
      "echo 'ðŸš€ Starting Monkey Coder with virtual environment activation...'",
      "echo 'Activating virtual environment at /app/venv'",
      "source /app/venv/bin/activate",
      "echo 'Virtual environment activated successfully'",
      "echo 'Python executable:' $(which python)",
      "echo 'Python version:' $(python --version)",
      "echo 'Uvicorn location:' $(which uvicorn)",
      "echo 'DEBUG: Checking frontend build locations before starting server:'",
      "echo '  /app/packages/web/out:' $(ls -d /app/packages/web/out 2>/dev/null && echo 'Exists' || echo 'Missing')",
      "echo '  /app/out:' $(ls -d /app/out 2>/dev/null && echo 'Exists' || echo 'Missing')",
      "echo '  /app/packages/web/out/index.html:' $(ls /app/packages/web/out/index.html 2>/dev/null && echo 'Exists' || echo 'Missing')",
      "echo 'Starting server with uvicorn...'",
      "cd /app",
      "/app/venv/bin/python run_server.py",
      "EOF",
      "chmod +x /app/start_server.sh",
      "echo 'âœ… Virtual environment activation script created at /app/start_server.sh'",
      "echo 'ðŸš€ Railpack build process completed successfully'"
    ]
  },
  "deploy": {
    "startCommand": "/app/start_server.sh",
    "healthCheckPath": "/health",
    "healthCheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3,
    "environment": {
      "VIRTUAL_ENV": "/app/venv",
      "PATH": "/app/venv/bin:$PATH",
      "PYTHONPATH": "/app:/app/packages/core",
      "ENABLE_A2A_SERVER": "true",
      "A2A_PORT": "7702"
    }
  }
}
