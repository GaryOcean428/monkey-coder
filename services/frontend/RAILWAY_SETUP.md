# Railway Setup Guide for Frontend Service

## Quick Setup

### 1. Create Frontend Service in Railway

1. Go to your Railway project
2. Click **"New Service"** → **"GitHub Repo"**
3. Select the `monkey-coder` repository
4. Name it: `monkey-coder` (frontend)

### 2. Configure Service Settings

**Settings → Service:**
- **Root Directory**: `services/frontend` (IMPORTANT!)
- **Builder**: Railpack (auto-detected from `railpack.json`)

### 3. Set Environment Variables

**Settings → Variables**, add the following:

```bash
# REQUIRED: Backend API URL
NEXT_PUBLIC_API_URL=https://monkey-coder-backend-production.up.railway.app

# REQUIRED: Frontend URL (will be auto-generated by Railway)
NEXT_PUBLIC_APP_URL=${{RAILWAY_PUBLIC_DOMAIN}}

# REQUIRED: NextAuth configuration
NEXTAUTH_URL=${{RAILWAY_PUBLIC_DOMAIN}}
NEXTAUTH_SECRET=<generate-with-openssl-rand-base64-32>

# OPTIONAL: Analytics
NEXT_PUBLIC_GA_ID=
NEXT_PUBLIC_POSTHOG_KEY=

# OPTIONAL: Feature flags
NEXT_PUBLIC_ENABLE_SOCIAL_LOGIN=false
NEXT_PUBLIC_ENABLE_API_KEYS=true
```

### 4. Generate Secrets

Generate secure secrets for production:

```bash
# For NEXTAUTH_SECRET (32-byte random string)
openssl rand -base64 32

# Or use Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

### 5. Deploy

1. Click **"Deploy"** or push to your GitHub branch
2. Railway will automatically:
   - Detect `railpack.json`
   - Install dependencies with Yarn 4.9.2
   - Build the Next.js app
   - Export static files
   - Serve them with `serve`

### 6. Verify Deployment

Once deployed:

1. Click the **"Open App"** button in Railway
2. Open browser DevTools → Console
3. Check for errors (should see no JSON parse errors)
4. Test login functionality
5. Check Network tab - API calls should go to backend URL

## Expected Build Process

Railway will execute these steps (from `railpack.json`):

```json
{
  "build": {
    "steps": {
      "install": {
        "commands": [
          "corepack enable",
          "corepack prepare yarn@4.9.2 --activate",
          "cd ../.. && yarn install --immutable"
        ]
      },
      "build": {
        "commands": [
          "cd ../.. && yarn workspace @monkey-coder/frontend build",
          "cd ../.. && yarn workspace @monkey-coder/frontend run export",
          "test -d out && echo '✅ Frontend build output verified'"
        ]
      }
    }
  }
}
```

## Expected Start Command

```bash
npx serve -s out -l $PORT --no-clipboard
```

Railway automatically sets `$PORT` - do not hardcode it!

## Troubleshooting

### Build Fails: "Cannot find workspace"

**Problem**: Root directory not set correctly.

**Solution**: 
1. Go to Settings → Service
2. Set **Root Directory** to `services/frontend`
3. Redeploy

### API Calls Still Failing

**Problem**: Environment variables not set or incorrect.

**Solution**:
1. Check `NEXT_PUBLIC_API_URL` is set to backend service URL
2. Check backend service is running and accessible
3. Test backend health: `https://monkey-coder-backend-production.up.railway.app/api/health`

### Build Works but Site Shows 404

**Problem**: Static export not found.

**Solution**:
1. Check build logs for errors
2. Verify `out` directory was created
3. Check start command is correct: `serve -s out -l $PORT`

### Environment Variables Not Taking Effect

**Problem**: Need to redeploy after changing env vars.

**Solution**:
1. Change environment variables
2. Click **"Redeploy"** or push new commit
3. Wait for build to complete

## Service Dependencies

The frontend service depends on:

1. **Backend Service** (`monkey-coder-backend-production`)
   - Must be running and accessible
   - Must have correct CORS configuration
   - URL: Set in `NEXT_PUBLIC_API_URL`

2. **No database required** (frontend is stateless static site)

## CORS Configuration

The backend service must allow requests from the frontend:

**In Backend Service Variables**:
```bash
CORS_ORIGINS=https://monkey-coder.up.railway.app,https://coder.fastmonkey.au
TRUSTED_HOSTS=monkey-coder.up.railway.app,*.railway.app
```

## Custom Domain Setup

If using a custom domain (e.g., `coder.fastmonkey.au`):

1. **In Railway Dashboard**:
   - Settings → Domains
   - Add custom domain: `coder.fastmonkey.au`
   - Update DNS records as instructed

2. **Update Environment Variables**:
   ```bash
   NEXT_PUBLIC_APP_URL=https://coder.fastmonkey.au
   NEXTAUTH_URL=https://coder.fastmonkey.au
   
   # If backend is on same domain:
   NEXT_PUBLIC_API_URL=https://coder.fastmonkey.au
   
   # If backend is on Railway:
   NEXT_PUBLIC_API_URL=https://monkey-coder-backend-production.up.railway.app
   ```

3. **Update Backend CORS**:
   ```bash
   CORS_ORIGINS=https://coder.fastmonkey.au,https://monkey-coder.up.railway.app
   ```

## Health Checks

Railway will check the root path (`/`) for health:

```json
{
  "deploy": {
    "healthCheckPath": "/",
    "healthCheckTimeout": 120
  }
}
```

The frontend should respond with the index.html page.

## Monitoring

**Useful Railway CLI Commands**:

```bash
# View logs
railway logs

# Check service status
railway status

# Open the deployed app
railway open

# SSH into the service (for debugging)
railway shell
```

## Resource Limits

**Free Tier**:
- 500 hours/month
- Sleeps after 5 minutes of inactivity
- Wakes on first request

**Hobby/Pro Tier**:
- Always on
- No sleep
- Better performance

## Security Best Practices

1. **Always use HTTPS** in production
2. **Keep secrets secure** - use Railway's environment variables
3. **Enable CORS properly** - only allow trusted domains
4. **Use httpOnly cookies** for authentication (backend handles this)
5. **Never commit secrets** to version control

## Next Steps

After successful deployment:

1. **Test all functionality**:
   - [ ] Login works
   - [ ] Models fetch works
   - [ ] API calls return JSON (not HTML)
   - [ ] Authentication persists
   - [ ] WebSocket connections work

2. **Set up monitoring**:
   - Add error tracking (Sentry)
   - Add analytics (Google Analytics, PostHog)
   - Monitor API response times

3. **Configure backups**:
   - Database backups (if using one)
   - Environment variables backup

4. **Set up CI/CD**:
   - Automatic deploys from main branch
   - Staging environment for testing

## Support

- Railway Documentation: https://docs.railway.app/
- Project Issues: https://github.com/GaryOcean428/monkey-coder/issues
- Railway Discord: https://discord.gg/railway
